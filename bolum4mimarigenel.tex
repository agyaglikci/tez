\chapter{BUYRUK KÜMESİ VE BORU HATTI MİMARİSİ}
İşlemci tasarımı buyruk kümesinin tasarlanması ile başlar, buyrukların koşturulabilmesi için gerekli donanımlar belirlenir ve bu donanımların yüksek verimli kullanımını sağlamak için boru hattı mimarisi tasarlanır. Tezin bu bölümünde öncelikli olarak buyruk kümesi mimarisi anlatılacak, ardından her buyruğun ihtiyaç duyduğu hesaplama modülleri belirlenecek, sonrasında kullanım senaryoları üzerinden boru hattı mimarisi tasarımı anlatılacaktır. \par

Literatür özetinde belirtilen mimari alternatifleri, çekirdek sayısı ve homojen - heterojen çekirdekler bakımından farklı sınıflara ayrılmıştır. Hedeflenen donanım bir FPGA platformudur. FPGA platformları, ASIC tasarımlara göre daha düşük saat sıklığında çalışabildiğinden, uygulamanın yüksek seviyede paralelleştirilmesi ile faydalı bir ürün oluşturulabilir. \par

\section{Buyruk Kümesi Mimarisi}
Hedeflenen işlemciye benzer özelliklerde mevcut paralel işlemcilerin buyruk kümesi mimarileri incelenmiş, gereksinim analizinde fonksiyonların gerçeklenebilmesi için gerekli olarak belirlenen buyruklar bu buyruk kümesi mimarilerine eklenerek Tosun işlemcisi için bir buyruk kümesi mimarisi oluşturulmuştur. Mevcut buyruk kümelerinin incelenmesinin sebebi paralel işlemcilerin mimari özelliklerinden bağımsız olarak sahip olması gereken ortak özelliklerin bulunmasıdır. Bu özelliklerden bazıları yükleme ve saklama operasyonları, threadler arası senkronizasyonun sağlanması, çekirdeklerin bellek erişimlerinde kullanılan adres hesaplamaları, yazmaçlar üzerinde yapılan okuma ve yazma işlemleridir. \par

Tosun buyruk kümesi mimarisinin oluşturulmasında NVidia PTX \cite{nvidiaPTXISA} buyruk kümesi paralel işleme mimarisi olarak temel alınmıştır. Ayrıca adres hesapları, dallanmalar, temel aritmetik ve mantık işlemleri gibi her işlemcinin sahip olması gereken temel buyruklar için de x86 \cite{x86ISA} ve MIPS \cite{MIPSISA} buyruk kümeleri referans alınmıştır. \par

Tosun buyruk kümesi mimarisinde bulunmasına karar verilen buyruklar tablo \ref{table:tosunInstructions} içinde sunulmuştur. 



\begin{longtable}{p{50pt} p{300pt} p{70pt}}
\caption{Tosun Buyruk Listesi} \label{table:tosunInstructions} \\
\multicolumn{1}{l}{\textbf{Buyruk}} & \multicolumn{1}{l}{\textbf{Açıklama}} & \multicolumn{1}{c}{\textbf{Türü}} \\ 
\hline 
\endfirsthead

\multicolumn{2}{c}%
{{\bfseries \tablename\ \thetable{} -- devam}} \\
\multicolumn{1}{l}{\textbf{Buyruk}} &
\multicolumn{1}{l}{\textbf{Açıklama}} &
\multicolumn{1}{c}{\textbf{Türü}}  \\ \hline 
\endhead

\hline \multicolumn{2}{r}{{Sonraki sayfada devam etmektedir.}} \\ 
\endfoot

\hline \hline
\endlastfoot
  addi		&	 $r_{d} = r_{s1} + 			$anlık 	& \multicolumn{1}{c}{Anlık} 	\\
  andi 		&	 $r_{d} = r_{s1} \& 		$anlık 	& \multicolumn{1}{c}{Anlık}  	\\
  ori 		&	 $r_{d} = r_{s1} | 			$anlık  & \multicolumn{1}{c}{Anlık}  	\\
  xori 		&	 $r_{d} = r_{s1} \oplus $anlık 	& \multicolumn{1}{c}{Anlık}  	\\
  divi 		&	 $r_{d} = r_{s1} / 			$anlık  & \multicolumn{1}{c}{Anlık}  	\\
  muli 		&	 $r_{d} = r_{s1} x 			$anlık  & \multicolumn{1}{c}{Anlık}  	\\
  subi 		&	 $r_{d} = r_{s1} - 			$anlık  & \multicolumn{1}{c}{Anlık}  	\\
  movi 		&	 $r_{d}(alt yarısı) = 	$anlık  & \multicolumn{1}{c}{Anlık}  	\\
  movhi		&	 $r_{d}(üst yarısı) = 	$anlık  & \multicolumn{1}{c}{Anlık}  	\\
  fabs  	&  $r_{d} = |r_{s1}|			$				&	\multicolumn{1}{c}{Y1}		 	\\
  fadd  	&  $r_{d} = r_{s1} + r_{s2}$			&	\multicolumn{1}{c}{Y2}		 	\\
  fcom  	&  $r_{d} = com(r_{s1},r_{s2})$		&	\multicolumn{1}{c}{Karşılaştırma}	 	\\
  fdiv  	&  $r_{d} = r_{s1} / r_{s2}$			&	\multicolumn{1}{c}{Y2}		 	\\
  fmul  	&  $r_{d} = r_{s1} x r_{s2}$			&	\multicolumn{1}{c}{Y2}		 	\\
  fsqrt  	&  $r_{d} = sqrt(r_{s1})$					&	\multicolumn{1}{c}{Y1}		 	\\
  fcos  	&  $r_{d} = cos(r_{s1})$					&	\multicolumn{1}{c}{Y1}		 	\\
  fsin  	&  $r_{d} = sin(r_{s1})$					&	\multicolumn{1}{c}{Y1}		 	\\
  ffma  	&  $r_{d} = r_{s1}xr_{s2}+r_{s3}$	&	\multicolumn{1}{c}{Y3}		 	\\
  ffms  	&  $r_{d} = r_{s1}xr_{s2}-r_{s3}$	&	\multicolumn{1}{c}{Y3}		 	\\
  fmin  	&  $r_{d} = min(r_{s1},r_{s2})$		&	\multicolumn{1}{c}{Y2}		 	\\
  fmax  	&  $r_{d} = max(r_{s1},r_{s2})$		& \multicolumn{1}{c}{Y2}			\\
  fln 	 	&	 $r_{d} = log_{e}(r_{s1})$			& \multicolumn{1}{c}{Y1}			\\
  fmod 		&	 $r_{d} = r_{s1} \% r_{s2} $ 		& \multicolumn{1}{c}{Y2}  		\\
  f2int 	&	 $r_{d} = r_{s1}$ 							& \multicolumn{1}{c}{Y1}  		\\
  int2f		&	 $r_{d} = r_{s1}$ 							& \multicolumn{1}{c}{Y1}  		\\
  fchs		&	 $r_{d} = -r_{s1}$ 							& \multicolumn{1}{c}{Y1}  		\\
  fexp 		&	 $r_{d} = e^{r_{s1}}$						& \multicolumn{1}{c}{Y1}  		\\
  add 		&	 $r_{d} = r_{s1} + r_{s2}$ 			& \multicolumn{1}{c}{Y2}  		\\
  and 		&	 $r_{d} = r_{s1} \& r_{s2}$ 		& \multicolumn{1}{c}{Y2}  		\\
  or 			&	 $r_{d} = r_{s1} | r_{s2}$			& \multicolumn{1}{c}{Y2}  		\\
  xor			&	 $r_{d} = r_{s1} xor r_{s2}$ 		& \multicolumn{1}{c}{Y2}  		\\
  div  		&  $r_{d}	= r_{s1} / r_{s2}$			&	\multicolumn{1}{c}{Y2}		 	\\
  mul  		&  $r_{d} = r_{s1} x r_{s2}$			&	\multicolumn{1}{c}{Y2}		 	\\
  shl  		&  $r_{d} = r_{s1} << r_{s2}$			&	\multicolumn{1}{c}{Y2}		 	\\
  shr  		&  $r_{d} = r_{s1} >> r_{s2}$			&	\multicolumn{1}{c}{Y2}			\\
  shra  	&  $r_{d} = r_{s1} >> r_{s2}$			&	\multicolumn{1}{c}{Y2}		 	\\
  sub  		&  $r_{d} = r_{s1} - r_{s2}$			&	\multicolumn{1}{c}{Y2}		 	\\
  min  		&  $r_{d} = min(r_{s1},r_{s2})$		&	\multicolumn{1}{c}{Y2}		 	\\
  max  		&  $r_{d} = max(r_{s1},r_{s2})$		&	\multicolumn{1}{c}{Y2}		 	\\
  chs  		&  $r_{d} = -r_{s1}$							&	\multicolumn{1}{c}{Y1}		 	\\
  not  		&  $r_{d} = ~r_{s1}$							&	\multicolumn{1}{c}{Y1}		 	\\
  abs  		&  $r_{d} = |r_{s1}|$							&	\multicolumn{1}{c}{Y1}		 	\\
  com  		&  $r_{d} = max(r_{s1},r_{s2})$		& \multicolumn{1}{c}{Y2}			\\
  mod  		&  $r_{d} = max(r_{s1},r_{s2})$		& \multicolumn{1}{c}{Y2}			\\
  brv 		&	 Verilen yazmaçtaki bitleri ters sırada hedef yazmaca yazar & \multicolumn{1}{c}{Y1}  \\
  bfr 		&	 Verilen yazmacın belirtilen kadar kısmını maskeleyip hedef yazmaca yazar & \multicolumn{1}{c}{Y1}  \\
  br 			&	 Karşılaştırma bayraklarında belirtilen koşul varsa, verilen adres kadar ileri atlar & \multicolumn{1}{c}{Dallanma}  \\
  fin 		&	 Programı sonlandırır& \multicolumn{1}{c}{Y0}  \\
  ldshr 	&	 Paylaşımlı bellekten yükleme işlemi yapar& \multicolumn{1}{c}{Y1}  \\
  stshr 	&	 Paylaşımlı belleğe saklama işlemi yapar& \multicolumn{1}{c}{Y1}  \\
  sync		&	 Tüm threadler aynı noktaya gelinceye kadar önce gelen threadleri bekletir. & \multicolumn{1}{c}{Y0}  \\
  ldram 	&	 Ana bellekten yükleme işlemi yapar& \multicolumn{1}{c}{Y1}  \\
  stram		&	 Ana belleğe saklama işlemi yapar& \multicolumn{1}{c}{Y1}  \\
  mov 		&  $r_{d}$ = $r_{s1}$ 						&	\multicolumn{1}{c}{Taşıma}		 \\
  jmp  		&  Program sayacına belirtilen sayıyı ekleyerek atlar &	\multicolumn{1}{c}{Atlama}		 \\
  
\end{longtable}

Tosun buyruk kümesinde toplam 56 adet buyruk belirlenmiştir. Tablo \ref{table:tosunInstructions} içinde verilen buyruklar içerdikleri işlenen tür ve sayılarına göre türlere ayrılmıştır. Bu sınıflandırma buyruk içinde belirtilmesi gereken işlenen cins ve sayılarına göre yapılmıştır. Buyruk türlerinin bit yapısının belirlenebilmesi için öncelikle buyruk içine yerleştirilecek bilgilerin bit genişlikleri belirlenmelidir. \par

Buyruk bit yapılarında kaynak ve hedef hafıza birimleri olarak yazmaç numaraları kullanılır. Buyruk içinde bir yazmacın kaç bit ile ifade edileceği, bir thread için tahsis edilen yazmaç sayısına bağlıdır. İşlemci mimarisinde yazmaç sayısının belirlenmesi bir ödünleşimli karardır. Yazmaç sayısının artması yazmaçlar için kullanılan alanı artıracağı gibi yazmaç numaraları için kullanılan karşılaştırıcı devrelerin de büyümesine sebep olur. Öte yandan yazmaç sayısının azlığı bellek işlemlerinin artmasına ve başarımın düşmesine sebep olacaktır. Tosun mimarisinde çok çekirdekli bir mimariden söz edildiği için yazmaç sayılarının artışı tek çekirdekli işlemcilere oranla daha fazla bir alan kullanımında artışa sebep olmaktadır. Bu yüzden Tosun mimarisinde hedef programlara yetebilecek minimum sayıda yazmaç kullanılmıştır. Bu çalışmada NVidia CUDA ile çalışan 184 adet paralel hesaplama uygulamasının yazmaç kullanım adetleri incelenmiştir. Elde edilen sonuçlara göre Tablo \ref{table:NVidiaRegisterUsage}'ta sunulduğu şekilde 64 adetten fazla sayıda yazmaç kullanan program ile karşılaşılmamıştır.

\begin{longtable}{p{350pt} p{100pt} }
\caption{NVidia GPGPU Programları Yazmaç Kullanım Analizi} \label{table:NVidiaRegisterUsage} \\
\multicolumn{1}{l}{\textbf{Açıklama}} & \multicolumn{1}{r}{\textbf{Adet}}  \\ 
\hline 
\endfirsthead
32 veya daha az sayıda yazmaç kullanan uygulamalar  & \multicolumn{1}{r}{138} \\
32 ile 64 adet arasında yazmaç kullanan uygulamalar & \multicolumn{1}{r}{46}  \\
64 yazmaçtan fazla sayıda yazmaç kullanan uygulamalar & \multicolumn{1}{r}{0} \\
\end{longtable}

Neticede her bir thread için 64 adet yazmaçtan oluşan yazmaç öbeği kullanılmasına karar verilmiştir. Projenin bir diğer isteği olan OpenCL desteği ise OpenCL spesifikasyonlarında belirtilen bazı özel amaçlı yazmaçların gerçeklenmesini zorunlu kılmaktadır. Lokal thread numarası ve global thread numarası gibi programcının erişimine açık olması gereken ve spesifikasyonda belirtilen bilgiler program içinde özellikle adres hesaplamalarında sıklıkla kullanılmakta olduğundan yazmaç öbeğinde tutulması faydalı olacaktır. Bu bilgilerin yanı sıra program parametrelerinin de yazmaç öbeğine dahil edilmesi ile yazmaç sayısı 128 adete çıkarılmıştır. Ancak 128 yazmacın yalnızca ilk 64 adedi genel amaçlı olup, son 64 adeti özel mov buyruğu ile erişilebilir olarak belirlenmiştir. Toplamda 64 adet genel amaçlı yazmaç, buyruk içinde 6 bit ile ifade edilebilir. \par

Tüm işlemler 32 bit genişliğinde float veya tam sayılar ile yapılmaktadır. Yazmaç sayıları ve işlem kodu da hesaba katıldığında genel olarak buyrukların 32 bit genişliğe sığdırılabileceği hesaplanmıştır. Buyruklar için ayrılan bellek alanının verimli kullanılabilmesi için buyruk genişliklerinin de 32 bitten fazla olmamasına karar verilmiş, bu sebeple de buyruk içinde verilen anlık değerler 16 bit genişliğine sabitlenmiştir. Bir yazmaca anlık bir değerin yazılması ise movi ve movhi buyruklarının peş peşe kullanılması ile mümkündür. \par

\subsection{Anlık türü buyruklar}
Anlık türü buyruklar bir kaynak yazmacı, bir hedef yazmacı ve bir anlık değer içerir. Dolayısıyla işlem kodu için yalnızca 4 bitlik boş yer kalır. 4 bit, işlem koduna yeterli olmadığı için, olası tasarım çözümleri anlık değerin daraltılması veya buyruk genişliğinin artırılmasıdır. Buyruk genişliğinin değiştirilmesi durumunda bellek yönetimi, buyruk çekme ve kod çözme donanımları karmaşıklaşırken anlık değerin daraltılması durumunda ilave buyruklar gerekeceği gibi, programcının da tasarımı karmaşıklaşmaktadır. Bu probleme özel bir çözüm olarak anlık türü buyrukların 4 bit işlem koduna sahip olmasına karar verilmiştir. Anlık buyruklarda işlem koduna 4 bit ayrılmış olması, işlem kodunun kalan alt bitlerinin x ile doldurulması anlamına gelir. Toplamda 9 adet anlık türü buyruk bulunmaktadır. Dolayısıyla üst 4 biti [0,9] aralığında olan işlem kodları anlık türünde, [10,15] aralığında olan işlem kodları ise diğer türlerdedir. Buyruk kümesinde anlık türü olmayan, 46 adet buyruk vardır. Üst 4 bit için kullanılmayan 6 farklı değer olduğundan alt bitler için 8 farklı değer, dolayısıyla 3 bit gereklidir. \par

Anlık türü buyruklardan kaynaklı bu değişiklik ile Tosun buyrukları 7 bit işlem kodu ile ifade edilir, 0000000 - 1001111 aralığındaki işlem kodları anlık türü buyruklara karşılık gelir, anlık türü buyruklarda alt 3 bit önemsiz olarak kabul edildiğinden yalnızca üst 4 bit buyruk içinde yer alır.\par

\begin{longtable}{p{130pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt} p{10pt}}
\caption{Buyruk Türleri} \label{table:NVidiaRegisterUsage} \\
\multicolumn{1}{l}{\textbf{Buyruk Türü}} & \multicolumn{32}{l}{\textbf{Bit Yapısı}}  \\ 
\multicolumn{1}{l}{} & \multicolumn{4}{c}{31-28} & \multicolumn{3}{l}{27-} & \multicolumn{3}{r}{-22} & \multicolumn{3}{l}{21-} & \multicolumn{3}{r}{-16} & \multicolumn{3}{c}{15-13} & \multicolumn{1}{c}{12} & \multicolumn{1}{r}{-7} & \multicolumn{6}{c}{6-1}   \\ 
\hline 
\endfirsthead
Anlık Türü & \multicolumn{4}{c}{İşlem kodu} & \multicolumn{6}{c}{Sonuç yazmacı} & \multicolumn{6}{c}{Kaynak yazmacı} & \multicolumn{16}{c}{Anlık Değer}
\end{longtable}


Bir işlemcide aynı anda birden fazla threadin koşturulması, paralel veri yolları ve hesaplama ünitelerinin gerçeklenmesi ile mümkün olur. Bu paralel yolların literatürdeki adı SIMD Lane'dir. FPGA donanım üzerinde gerçeklenecek bir işlemcinin yüksek seviyede paralel olması SIMD Lane sayısının artırılması ile mümkündür. Öte yandan SIMD Lane sayısının artması, hem alan kullanımında sebep olduğu artıştan dolayı saat sıklığını kısıtlamakta hem de ortak kullanılan verilere erişimde darboğaz oluşmasına sebep olmaktadır. Dolayısıyla SIMD lane sayısının belirlenmesi bir en iyileme problemidir. Tosun mimarisinin tasarımında SIMD lane sayısı NVidia GPU mimarilerinin incelenmesi ve tüm SIMD Lane'ler tarafından ortak kullanılan paylaşımlı bellek üzerinde oluşacak darboğazın hesaplanması ile kararlaştırılmıştır. \par

Mevcut paralel işlemcilerde  Gereksinim analizi neticesinde fonksiyon listesinde belirtilen fonksiyonların gerçeklenmesi için gerekli buyruklar Tablo \ref{table:instructionList1} belirtilmiştir. 
